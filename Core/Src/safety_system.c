#include "safety_system.h"\n#include "main.h"\n#include "sensor_manager.h"\n#include "motor_control.h"\n\n#define ABS_SLIP_THRESHOLD 20\n#define TCS_SLIP_THRESHOLD 15\n#define MAX_CURRENT_MA 25000\n#define MAX_TEMP_C 90.0f\n#define CAN_TIMEOUT_MS 250\n\ntypedef struct {\n    uint8_t abs_active;\n    uint8_t tcs_active;\n    uint8_t overcurrent;\n    uint8_t overtemp;\n    uint8_t can_timeout;\n    uint8_t emergency_stop;\n} SafetyFlags_t;\n\nSafetyFlags_t safety_flags = {0};\nuint32_t last_can_rx_time = 0;\n\nvoid Safety_Init(void) {\n    safety_flags.abs_active = 0;\n    safety_flags.tcs_active = 0;\n    last_can_rx_time = HAL_GetTick();\n}\n\nvoid ABS_Update(void) {\n    uint16_t speed_fl = Wheel_GetSpeed_FL();\n    uint16_t speed_fr = Wheel_GetSpeed_FR();\n    uint16_t speed_rl = Wheel_GetSpeed_RL();\n    uint16_t speed_rr = Wheel_GetSpeed_RR();\n    uint16_t avg = (speed_fl + speed_fr + speed_rl + speed_rr) / 4;\n    if (avg < 100) { safety_flags.abs_active = 0; return; }\n    int32_t slip = ((avg - speed_fl) * 100) / avg;\n    if (slip > ABS_SLIP_THRESHOLD) { safety_flags.abs_active = 1; Traction_SetThrottle(0); }\n}\n\nvoid TCS_Update(void) {\n    uint16_t speed_fl = Wheel_GetSpeed_FL();\n    uint16_t avg = (speed_fl + Wheel_GetSpeed_FR() + Wheel_GetSpeed_RL() + Wheel_GetSpeed_RR()) / 4;\n    if (avg < 50) { safety_flags.tcs_active = 0; return; }\n    int32_t slip = ((speed_fl - avg) * 100) / avg;\n    if (slip > TCS_SLIP_THRESHOLD) { safety_flags.tcs_active = 1; Traction_SetThrottle(Pedal_GetPercent() / 2); }\n}\n\nvoid Safety_CheckCurrent(void) {\n    uint16_t max = 0;\n    for (uint8_t i = 0; i < 6; i++) { uint16_t c = Current_Get(i); if (c > max) max = c; }\n    if (max > MAX_CURRENT_MA) { safety_flags.emergency_stop = 1; Traction_EmergencyStop(); }\n}\n\nvoid Safety_CheckTemperature(void) {\n    float max = 0.0f;\n    for (uint8_t i = 0; i < 5; i++) { float t = Temperature_Get(i); if (t > max) max = t; }\n    if (max > MAX_TEMP_C) { safety_flags.emergency_stop = 1; Traction_EmergencyStop(); }\n}\n\nvoid Safety_CheckCANTimeout(void) {\n    if ((HAL_GetTick() - last_can_rx_time) > CAN_TIMEOUT_MS) { safety_flags.can_timeout = 1; Traction_EmergencyStop(); }\n}\n\nvoid Safety_UpdateCANRxTime(void) { last_can_rx_time = HAL_GetTick(); }\nuint8_t Safety_IsABSActive(void) { return safety_flags.abs_active; }\nuint8_t Safety_IsTCSActive(void) { return safety_flags.tcs_active; }\nuint8_t Safety_IsEmergencyStop(void) { return safety_flags.emergency_stop; }