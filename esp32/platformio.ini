; =============================================================================
; ESP32-S3 HMI Firmware — PlatformIO Configuration
;
; Framework:  Arduino ONLY (no ESP-IDF)
; Language:   C++ (C++17)
; Board:      ESP32-S3-DevKitC-1
; Display:    480×320 TFT via TFT_eSPI (ST7796 driver, landscape rotation 1)
; CAN Bus:    500 kbps via TJA1051 transceiver (GPIO4 TX, GPIO5 RX)
;
; Reference:  docs/ESP32_FIRMWARE_DESIGN.md
;             docs/CAN_CONTRACT_FINAL.md rev 1.3
;             docs/HMI_RENDERING_STRATEGY.md
; =============================================================================

[env:esp32s3]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

; ---------- Flash & PSRAM (ESP32-S3-WROOM-1-N8R8) ----------------
; Flash: 8 MB Quad, PSRAM: 8 MB Octal (detected as AP_3v3 by esptool)
; WARNING: qio_opi is specific to Octal PSRAM hardware.
;          Other board variants may require different memory_type.
board_build.arduino.memory_type = qio_opi
board_build.flash_mode = qio
board_build.psram_type = opi
board_upload.flash_size = 8MB
board_upload.maximum_size = 8388608
board_build.partitions = default_8MB.csv

; C++ standard
build_flags =
    -std=gnu++17
    -Wall
    -Wextra
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DBOARD_HAS_PSRAM=1  ; Required for psramInit() and PSRAM APIs
    ; --- TFT_eSPI configuration (ST7796, 320×480) ---
    -DUSER_SETUP_LOADED=1
    -DST7796_DRIVER=1
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=480
    -DTFT_MISO=-1
    -DTFT_MOSI=13
    -DTFT_SCLK=14
    -DTFT_CS=15
    -DTFT_DC=16
    -DTFT_RST=17
    -DTFT_BL=42
    -DTFT_BACKLIGHT_ON=1
    -DSPI_FREQUENCY=40000000
    -DSPI_READ_FREQUENCY=20000000
    -DTOUCH_CS=21
    -DSPI_TOUCH_FREQUENCY=2500000
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DSMOOTH_FONT=1

build_unflags =
    -std=gnu++11

; ---------- Upload settings (ESP32-S3 native USB-CDC) -----------
; The ESP32-S3 DevKitC uses the built-in USB peripheral for both serial
; monitor and firmware upload.  PlatformIO usually auto-detects the port,
; but if you get "Could not open COMx" or "PermissionError" on Windows:
;   1. Close any serial monitor / terminal that is using the port.
;   2. Hold the BOOT button, press RESET, then release BOOT to enter
;      download mode before uploading.
;   3. Uncomment the line below and set it to the correct port:
;        Windows  →  upload_port = COM3   (check Device Manager)
;        Linux    →  upload_port = /dev/ttyACM0
;        macOS    →  upload_port = /dev/cu.usbmodem*
; upload_port = COM3
upload_speed = 921600

; Serial monitor
monitor_speed = 115200
monitor_rts = 0
monitor_dtr = 0

; Library dependencies
lib_deps =
    handmade0octopus/ESP32-TWAI-CAN@^1.0.1
    bodmer/TFT_eSPI@^2.5.43
